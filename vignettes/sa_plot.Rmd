---
title: "Sensibility Analysis"
author: "Fabien Jossaud, Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r echo=FALSE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=3, eval=TRUE, echo=FALSE, results="hide", show.warnings=FALSE)
source("common.R")
source("sa_params.R")
```

```{r}
stats = lapply(gses, function(gse) { 
  results = lapply(ns, function(n) {
    results = lapply(ps, function(p) {
      results = lapply(seeds, function(seed) {
        results_file = paste0("results_gse", gse, "n", n, "seed", seed, "p", p,".rds")
        if (file.exists(results_file)) {
          results = mreadRDS(results_file)
          results = as.list(results)
          results$n    = n    
          results$p    = p    
          results$seed = seed 
          results$gse  = gse  
          return(results)
        } else {
          NULL
        }
      })
      results = do.call(rbind, results)
      results = as.data.frame(results)
      results = data.frame(lapply(data.frame(results, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
      return(results)
    })
    results = do.call(rbind, results)
    results = as.data.frame(results)
    results = data.frame(lapply(data.frame(results, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
    return(results)
  })
  results = do.call(rbind, results)
  results = as.data.frame(results)
  results = data.frame(lapply(data.frame(results, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
  return(results)
})
stats = do.call(rbind, stats)
stats = as.data.frame(stats)
stats = data.frame(lapply(data.frame(stats, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)














for (i in c(1, 3)){
  layout(matrix(1:length(gses), 1), respect=TRUE)
  for(gse in gses){ 
  
    # plot(0, 0, col=0, xlab="p", ylab= names_res[3], main=paste0(gse), xlim=range(results_g$p), ylim=c(0, max(results_g$up)))
    # ns = unique(results_g$n)
    # foo = lapply(ns, function(n) {
    #   results = results_g[results_g$n==n,]
    #   tmp_col = which(n==ns)
    #   lines(results$p, results$var, col=tmp_col, lty=1, type = "b")
    #   arrows(x0=results$p, y0=results$lo, x1=results$p, y1=results$up, code=3, angle=90, length = 0.03, col=tmp_col, lwd=2)
    # })
    # legend(x="bottomleft", legend=ns, fill=1:length(ns), title="n")
    
    formula = as.formula(paste0(colnames(stats)[i], "~n+p"))
    boxplot(formula, stats[stats$gse==gse,], col=1:3, las=2, main=gse)
    legend(x="bottomleft", legend=ns, fill=1:length(ns), title="n")
  }
}


m = lm(exec_time~n+p+gse, stats)
summary(m)
anova(m)

m = lm(rmsemod2_test~n+p+gse, stats)
summary(m)
anova(m)












  for (i in 1:17){
    layout(matrix(1:3, 1), respect=TRUE)
  plot(0, 0, col=0, xlab="p", ylab= names_res[3], main=paste0(gse), xlim=range(results_g$p), ylim=c(0, max(results_g$up)))
  ns = unique(results_g$n)
  foo = lapply(ns, function(n) { 
    results = results_g[results_g$n==n,]
    tmp_col = which(n==ns)
    lines(results$p, results$var, col=tmp_col, lty=1, type = "b")
    arrows(x0=results$p, y0=results$lo, x1=results$p, y1=results$up, code=3, angle=90, length = 0.03, col=tmp_col, lwd=2)
  })
  legend(x="bottomleft", legend=ns, fill=1:length(ns), title="n")
  
  }
}
```
