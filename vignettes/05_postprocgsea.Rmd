---
title: "Post processing `GSEA`"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---

## TCGA-LUSC

```{r gsea apply, fig.width=9, fig.height=9}
plot_gseafig  = function(key) {
  tcga_id = "TCGA-LUSC"
  s = mreadRDS(paste0("~/projects/datashare/", tcga_id, "/study_preproc_", tcga_id, ".rds"))
  e = s$exp_grp
  idx = intersect(e[e$tissue_status == "normal",]$id_patient, e[e$tissue_status == "tumoral",]$id_patient)
  e = e[e$id_patient%in%idx,]
  tab1 = table(e[e$tissue_status == "normal",]$id_patient)
  tab2 = table(e[e$tissue_status == "tumoral",]$id_patient)
  idx = intersect(names(tab1)[tab1==1], names(tab2)[tab2==1])    
  e = e[e$id_patient%in%idx,]
  tab = table(e$id_patient, e$tissue_status)
  tab
  if (!all(tab==1)|nrow(tab)==0) {stop(paste0("Problem pairing samples for ", tcga_id))}



  layout(matrix(c(
  1,1,1,1,2,2,
  1,1,1,1,2,2,
  1,1,1,1,3,3,
  1,1,1,1,3,3,
  4,4,5,7,7,8,
  4,4,6,7,7,9,
  NULL), 6, byrow=TRUE), respect=TRUE)

  qt = quantile(e$age)
  idx_yng = rownames(e)[e$age<=qt[2]]
  idx_old = rownames(e)[e$age>=qt[4]]
  individuals = list(rownames(e), youngest=idx_yng, oldest=idx_old)
  l_it = 1 # iterator for letter index on figure
  for (i in 1:length(individuals)) {
    idx = individuals[[i]]
    d = s$data[,idx]
    da = apply(d[,idx[e[idx,]$tissue_status=="tumoral"]], 1, mean) - apply(d[,idx[e[idx,]$tissue_status=="normal"]], 1, mean)
    da = sort(da)
    gsea_input = data.frame(probe=names(da), meth=da)
    head(gsea_input)
    dim(gsea_input)
    rnk_filename = paste0("gsea_input_", tcga_id, ".rnk")
    print(paste("gsea_input were exported in", rnk_filename, "file."))
    write.table(gsea_input, rnk_filename, sep="\t", row.names=FALSE, col.names=FALSE, quote=FALSE)
    tmp_probes = rownames(ewas)[ewas[[key]]==1]
    if (i>1) { levs = c("PM", "O") } else { levs = c(key, "background") }
    ylab = ifelse(i>1, "diff. meth.", "differential methylation")
    gsea_input$grp = levs[[2]]
    gsea_input[tmp_probes,]$grp = levs[[1]]
    gsea_input$grp = factor(gsea_input$grp, levels=levs)
    gsea_input[tmp_probes,]$grp
    grp_filename = paste0(key, ".grp")
    write.table(tmp_probes, quote=FALSE, row.names=FALSE, col.names=FALSE, grp_filename)
    gsea_plot(grp_filename, rnk_filename, main=tcga_id)  
    l = letters[l_it] ; l_it = l_it + 1
    put_a_letter(paste0(l))
    
    if (i>1) { par(mar=c(2.1, 4.1, 2.1, .6)) } else { 	par(mar=c(5.1, 4.1, 4.1, .6)) }
    mw_pv = wilcox.test(gsea_input$meth[gsea_input$grp==levs[2]], gsea_input$meth[gsea_input$grp!=levs[2]])$p.value
    main = ifelse(i>1, paste0("MW pv=", signif(mw_pv, 2)), paste0("Mann Whitney pv=", signif(mw_pv, 2)))
    ylab = ifelse(i>1, "diff. meth.", "differential methylation")
    las = ifelse(i>1, 1, 2)
    tmpx = paste0(gsea_input$grp, " (", table(gsea_input$grp)[gsea_input$grp], " probes)")
    tmpx = gsea_input$grp
    beanplot::beanplot(gsea_input$meth ~ tmpx, what=c(1,1,0,0), col="grey", main=main, ylab=ylab, las=las, yaxt="n")
    axis(2, at=c(-.5,0,.5)) 
    l = letters[l_it] ; l_it = l_it + 1
    put_a_letter(paste0(l))

    if (i>1) { par(mar=c(4.1, .6, 2.6, .6))} else {par(mar=c(5.1, .6, 2.1, .6)) }
    if (i>1) { main = paste0(length(idx)/2, " ", names(individuals)[i], " ind.") } else { main = paste0(length(idx)/2, " ", names(individuals)[i], " individuals") }
    plot(density(e[idx, ]$age), xlab="age (years)", ylab="", yaxt="n", main=main)
    abline(v=qt, lty=2, col="grey")
    l = letters[l_it] ; l_it = l_it + 1
    put_a_letter(paste0(l))

    par(mar=c(5.1, 4.1, 4.1, 2.1))
  }
}
plot_gseafig("predimeth")
# stop("EFN")
# png("gseafig.png", width=1200, height=1200) 
pdf(paste0("fig_", gse, "_gsea.pdf"), width=9, height=9) 
plot_gseafig("predimeth")
dev.off()
# plot_gseafig("hannum")
# plot_gseafig("horvath")
# plot_gseafig("phenoage")
# plot_gseafig("morandini")
# plot_gseafig("bonf01")



plot_gseasupfig  = function(keys) {
  tcga_id = "TCGA-LUSC"
  s = mreadRDS(paste0("~/projects/datashare/", tcga_id, "/study_preproc_", tcga_id, ".rds"))
  e = s$exp_grp
  idx = intersect(e[e$tissue_status == "normal",]$id_patient, e[e$tissue_status == "tumoral",]$id_patient)
  e = e[e$id_patient%in%idx,]
  tab1 = table(e[e$tissue_status == "normal",]$id_patient)
  tab2 = table(e[e$tissue_status == "tumoral",]$id_patient)
  idx = intersect(names(tab1)[tab1==1], names(tab2)[tab2==1])    
  e = e[e$id_patient%in%idx,]
  tab = table(e$id_patient, e$tissue_status)
  tab
  if (!all(tab==1)|nrow(tab)==0) {stop(paste0("Problem pairing samples for ", tcga_id))}



  layout(matrix(1:3, 1), respect=TRUE)

  # qt = quantile(e$age)
  # idx_yng = rownames(e)[e$age<=qt[2]]
  # idx_old = rownames(e)[e$age>=qt[4]]
  individuals = list(rownames(e))#, youngest=idx_yng, oldest=idx_old)
  l_it = 1 # iterator for letter index on figure
  for (i in 1:length(keys)) {
    key = keys[i]
    idx = rownames(e)
    d = s$data[,idx]
    da = apply(d[,idx[e[idx,]$tissue_status=="tumoral"]], 1, mean) - apply(d[,idx[e[idx,]$tissue_status=="normal"]], 1, mean)
    da = sort(da)
    gsea_input = data.frame(probe=names(da), meth=da)
    head(gsea_input)
    dim(gsea_input)
    rnk_filename = paste0("gsea_input_", tcga_id, ".rnk")
    print(paste("gsea_input were exported in", rnk_filename, "file."))
    write.table(gsea_input, rnk_filename, sep="\t", row.names=FALSE, col.names=FALSE, quote=FALSE)
    tmp_probes = rownames(ewas)[ewas[[key]]==1]
    if (i>1) { levs = c("PM", "O") } else { levs = c(key, "background") }
    ylab = ifelse(i>1, "diff. meth.", "differential methylation")
    gsea_input$grp = levs[[2]]
    gsea_input[tmp_probes,]$grp = levs[[1]]
    gsea_input$grp = factor(gsea_input$grp, levels=levs)
    gsea_input[tmp_probes,]$grp
    grp_filename = paste0(key, ".grp")
    write.table(tmp_probes, quote=FALSE, row.names=FALSE, col.names=FALSE, grp_filename)
    gsea_plot(grp_filename, rnk_filename, main=tcga_id)  
    l = letters[l_it] ; l_it = l_it + 1
    put_a_letter(paste0(l))
    
    # if (i>1) { par(mar=c(2.1, 4.1, 2.1, .6)) } else { 	par(mar=c(5.1, 4.1, 4.1, .6)) }
    # mw_pv = wilcox.test(gsea_input$meth[gsea_input$grp==levs[2]], gsea_input$meth[gsea_input$grp!=levs[2]])$p.value
    # main = ifelse(i>1, paste0("MW pv=", signif(mw_pv, 2)), paste0("Mann Whitney pv=", signif(mw_pv, 2)))
    # ylab = ifelse(i>1, "diff. meth.", "differential methylation")
    # las = ifelse(i>1, 1, 2)
    # tmpx = paste0(gsea_input$grp, " (", table(gsea_input$grp)[gsea_input$grp], " probes)")
    # tmpx = gsea_input$grp
    # beanplot::beanplot(gsea_input$meth ~ tmpx, what=c(1,1,0,0), col="grey", main=main, ylab=ylab, las=las, yaxt="n")
    # axis(2, at=c(-.5,0,.5)) 
    # l = letters[l_it] ; l_it = l_it + 1
    # put_a_letter(paste0(l))

    # if (i>1) { par(mar=c(4.1, .6, 2.6, .6))} else {par(mar=c(5.1, .6, 2.1, .6)) }
    # if (i>1) { main = paste0(length(idx)/2, " ", names(individuals)[i], " ind.") } else { main = paste0(length(idx)/2, " ", names(individuals)[i], " individuals") }
    # plot(density(e[idx, ]$age), xlab="age (years)", ylab="", yaxt="n", main=main)
    # abline(v=qt, lty=2, col="grey")
    # l = letters[l_it] ; l_it = l_it + 1
    # put_a_letter(paste0(l))

    par(mar=c(5.1, 4.1, 4.1, 2.1))
  }
}


plot_gseasupfig(names(signatures))
pdf(paste0("fig_gseasup.pdf"), width=9, height=3) 
plot_gseasupfig(names(signatures))
dev.off()



```



## Tables

```{r table ewas}
# ewas = ewas[, c(setdiff(colnames(ewas), tmp_names), tmp_names)]
exported_ewas = ewas[rownames(ewas)%in%probes_signature,]

col_oi = c(
  "chr_hg38"   ,
  "start_hg38" ,
  "end_hg38"   ,
  "name"       ,
  "beta_age"   , 
  "strand_hg38",
  "gene"       ,
  "group" 
)

exported_ewas = exported_ewas[, c(col_oi, setdiff(colnames(exported_ewas), col_oi))]


exported_ewas[,1] = as.character(exported_ewas[,1])
exported_ewas = exported_ewas[order(exported_ewas[,1], exported_ewas[,2]),]

ewas_xlsx_filename = paste0("ewas_", gse, ".xlsx")
ewas_bed_filename = paste0("ewas_", gse, ".bed")
WriteXLS::WriteXLS(exported_ewas, ewas_xlsx_filename)
write.table(exported_ewas, file=ewas_bed_filename , sep="\t", quote=FALSE, row.names=FALSE, col.names=TRUE)
```

Table of ewas results is exported `r ewas_xlsx_filename` for 1% Bonferroni probes.




